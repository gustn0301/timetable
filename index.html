<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1í•™ë…„ 4ë°˜ 2í•™ê¸° ì‹¤ì‹œê°„ ì‹œê°„í‘œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ì„¤ì • ë° ì´ˆê¸°í™”
        let app, auth, db;
        
        try {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug'); // Set debug level for logs
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
        }

        async function signIn() {
            try {
                // Use the global __initial_auth_token directly
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
            }
        }
        
        let userId = '';
        let isAuthReady = false;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                userId = crypto.randomUUID(); // Use a random string for unauthenticated users
            }
            isAuthReady = true;
            console.log("Authentication state changed. User ID:", userId);
            
            if (isAuthReady) {
                // Now that Firebase is ready, we can start loading data
                loadAnnouncements();
            }
        });
        
        window.firebase = {
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
            auth,
            db,
            userId: () => userId,
            isAuthReady: () => isAuthReady,
            collection,
            doc,
            getDocs,
            addDoc,
            deleteDoc,
            onSnapshot,
            query
        };

        signIn();
    </script>
    <style>
        :root {
            --bg-start-color: #f0f4f8;
            --bg-end-color: #e6e9f0;
            --main-color: #2c3e50;
            --accent-color: #4299e1;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            color: var(--main-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            transition: background 1s ease;
            background: linear-gradient(to bottom right, var(--bg-start-color), var(--bg-end-color));
            position: relative;
            overflow-x: hidden;
            flex-direction: column;
        }

        .container {
            position: relative;
            z-index: 2;
            display: flex;
            width: 95%;
            max-width: 1400px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: opacity 0.5s ease-in-out;
            flex-direction: column;
        }
        
        @media (min-width: 769px) {
            .container {
                flex-direction: row;
            }
        }

        .left-section {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: white;
            color: var(--main-color);
            transition: background 1s ease;
        }

        .left-section h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #weather-display {
            margin-left: 10px;
            font-size: 0.8em;
            color: #555;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        #weather-icon {
            font-size: 1.5em;
        }

        .left-section h1 {
            font-size: 5em;
            font-weight: 700;
            margin: 0;
            letter-spacing: -2px;
        }

        .current-class-info {
            margin-top: 30px;
            font-size: 1.3em;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 25px;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.6;
        }

        .current-class-info p {
            margin: 5px 0;
        }
        
        #class-name {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
        }

        .right-section {
            flex: 2;
            padding: 40px;
            overflow-x: auto;
        }

        .right-section h2 {
            text-align: center;
            font-size: 2em;
            color: var(--main-color);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1em;
            text-align: center;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #e0e6ed;
            padding: 8px 5px;
        }

        th {
            background-color: var(--main-color);
            color: white;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        td.highlight {
            background-color: #f7d794 !important;
            font-weight: bold;
            color: #a05a00;
            border: 2px solid #e2a03d !important;
            transition: background-color 0.3s ease;
        }

        .class-cell-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }

        .class-name {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        .class-details {
            font-size: 0.7em;
            color: #555;
        }

        @media (max-width: 768px) {
            .left-section {
                padding: 20px;
            }
            .left-section h1 {
                font-size: 3em;
            }
            .current-class-info {
                padding: 15px;
                font-size: 1em;
            }
            .right-section {
                padding: 20px 10px;
            }
            .right-section h2 {
                font-size: 1.5em;
            }
            table {
                font-size: 0.7em;
            }
            th, td {
                padding: 5px 3px;
            }
            .class-name {
                font-size: 0.9em;
                margin-bottom: 2px;
            }
            .class-details {
                font-size: 0.6em;
            }
        }
        
        .announcement-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            width: 95%;
            max-width: 1400px;
            text-align: center;
        }
        .announcement-section h3 {
            font-size: 1.5em;
            color: var(--main-color);
            margin-bottom: 10px;
        }
        #announcement-content {
            padding: 10px;
            text-align: left;
            min-height: 30px;
        }
        .announcement-item {
            font-size: 1.2em;
            color: #555;
            line-height: 1.5;
            padding: 5px 0;
            border-bottom: 1px dashed #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .announcement-item:last-child {
            border-bottom: none;
        }
        .announcement-text {
            flex: 1;
            padding-right: 10px;
        }
        
        .admin-button-container {
            margin-top: 20px;
            text-align: center;
        }
        .admin-button {
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            color: white;
            background-color: var(--accent-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .admin-button:hover {
            background-color: #3b82f6;
            transform: translateY(-2px);
        }

        #admin-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        #admin-panel h3 {
            margin-top: 0;
            text-align: center;
        }
        #admin-panel textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 15px;
            box-sizing: border-box;
            resize: vertical;
        }
        #admin-panel button {
            padding: 12px;
            font-size: 1em;
            font-weight: bold;
            color: white;
            background-color: #2c3e50;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-left: 5px;
        }
        #admin-panel button:hover {
            background-color: #1a242f;
        }
        #new-announcement-group {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin-bottom: 20px;
        }
        #new-announcement-group button {
            width: 100%;
            margin-left: 0;
            margin-top: 10px;
        }
        #admin-announcement-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .delete-btn:hover {
            background-color: #c0392b;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #fefefe;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal-content h3 {
            margin-top: 0;
            font-size: 1.5em;
            color: var(--main-color);
        }
        .modal-content p {
            font-size: 1em;
            color: #555;
            margin-bottom: 15px;
        }
        .modal-content input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        .modal-content button {
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            color: white;
            background-color: var(--accent-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .modal-content button:hover {
            background-color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Section: Current Time and Class Info -->
        <div class="left-section">
            <h2 id="current-date"></h2>
            <div id="weather-display">
                <span id="weather-icon"></span>
                <span id="temperature"></span>
            </div>
            <h1 id="current-time"></h1>
            <div class="current-class-info">
                <span id="class-name"></span>
                <p id="teacher-name-p">ì„ ìƒë‹˜: <span id="teacher-name"></span></p>
                <p>ì¥ì†Œ: <span id="location"></span></p>
            </div>
            <p id="special-message" style="margin-top: 20px; font-size: 1.1em; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);"></p>
        </div>

        <!-- Right Section: Full Timetable -->
        <div class="right-section">
            <h2>ì£¼ê°„ ì‹œê°„í‘œ</h2>
            <div style="overflow-x: auto;">
                <table id="timetable">
                    <thead>
                        <tr>
                            <th>êµì‹œ</th>
                            <th>ì›”</th>
                            <th>í™”</th>
                            <th>ìˆ˜</th>
                            <th>ëª©</th>
                            <th>ê¸ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- The timetable content is generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Announcement Section -->
    <div class="announcement-section">
        <h3>ê³µì§€ì‚¬í•­</h3>
        <div id="announcement-content"></div>
    </div>

    <!-- Admin Mode Button -->
    <div class="admin-button-container">
        <button id="admin-mode-btn" class="admin-button">ê´€ë¦¬ì ëª¨ë“œ</button>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
        <h3>ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
        <div id="new-announcement-group">
            <textarea id="new-announcement-input" placeholder="ìƒˆ ê³µì§€ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <button id="add-announcement-btn">ì¶”ê°€</button>
        </div>
        <div id="admin-announcement-list"></div>
        <button id="exit-admin-btn">ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ</button>
    </div>
    
    <!-- Admin Code Modal -->
    <div id="code-modal" class="modal">
        <div class="modal-content">
            <h3>ê´€ë¦¬ì ì½”ë“œ ì…ë ¥</h3>
            <p id="modal-message"></p>
            <input type="password" id="admin-code-input" placeholder="ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button id="check-code-btn">í™•ì¸</button>
        </div>
    </div>

    <script type="module">
        const timetableData = {
            'ì›”': [
                { name: 'í†µí•©ê³¼í•™2', teacher: 'ì´í˜„ìš°T', location: '1í•™ë…„ 3ë°˜ êµì‹¤' },
                { name: 'ì¸ê³µì§€ëŠ¥ê¸°ì´ˆ', teacher: 'ê¹€ìš©ìƒT, í•˜ë¯¸ê²½T', location: 'AI ì‹¬í¬ì§€ì›€' },
                { name: 'í†µí•©ì‚¬íšŒ2', teacher: 'ê¹€í˜•ì„T', location: '1í•™ë…„ 7ë°˜ êµì‹¤' },
                { name: 'ê³µê°• ëª¨ì˜ê³ ì‚¬', teacher: 'ì´ì§€ì—°T', location: '1í•™ë…„ 4ë°˜ êµì‹¤' },
                { name: 'ê³µí†µìˆ˜í•™2', teacher: 'ìœ ì§€í˜„T', location: '1í•™ë…„ 5ë°˜ êµì‹¤' },
                { name: 'ê³µí†µêµ­ì–´2', teacher: 'ì´ì •ì›T', location: '1í•™ë…„ 1ë°˜ êµì‹¤' },
                { name: 'ê³µí†µì˜ì–´2', teacher: 'ì´ì§€ì—°T', location: '1í•™ë…„ 4ë°˜ êµì‹¤' }
            ],
            'í™”': [
                { name: 'ì¢…êµ', teacher: 'ê¹€ë™í•´ ì‹ ë¶€ë‹˜', location: 'J301' },
                { name: 'í†µí•©ê³¼í•™2', teacher: 'í™ì†Œì˜T', location: '3í•™ë…„ 6ë°˜ êµì‹¤' },
                { name: 'ìŠ¤í¬ì¸ ê³¼í•™', teacher: 'ì€í˜„ì§„T', location: 'ë§ˆë¦¬ì•„í™€' },
                { name: 'ê³µí†µì˜ì–´2', teacher: 'ê¹€ì˜ë¯¸T', location: '1í•™ë…„ 6ë°˜ êµì‹¤' },
                { name: 'ê³µí†µêµ­ì–´2', teacher: 'ì „ë¯¼ì§€T', location: 'AI ì¸í…”ë¦¬ë©' },
                { name: 'í•œêµ­ì‚¬2', teacher: 'í•œìš°ì§„T', location: 'ì‚¬íšŒêµê³¼ì‹¤' },
                { name: 'ê³µí†µìˆ˜í•™2', teacher: 'ìœ ì§€í˜„T', location: '1í•™ë…„ 5ë°˜ êµì‹¤' }
            ],
            'ìˆ˜': [
                { name: 'ê³µí†µìˆ˜í•™2', teacher: 'ìœ ì§€í˜„T', location: '1í•™ë…„ 5ë°˜ êµì‹¤' },
                { name: 'í†µí•©ê³¼í•™2', teacher: 'ì´í˜„ìš°T', location: '1í•™ë…„ 3ë°˜ êµì‹¤' },
                { name: 'í•œêµ­ì‚¬2', teacher: 'í•œìš°ì§„T', location: 'ì‚¬íšŒêµê³¼ì‹¤' },
                { name: 'ê³¼í•™íƒêµ¬ì‹¤í—˜2', teacher: 'ê¹€ë³´ë ¨T', location: '3ì¸µ í™”í•™ì‹¤í—˜ì‹¤' },
                { name: 'ê³µí†µêµ­ì–´2', teacher: 'ì´ì •ì›T', location: '1í•™ë…„ 1ë°˜ êµì‹¤' },
                { name: 'ì¸ê³µì§€ëŠ¥ê¸°ì´ˆ', teacher: 'ê¹€ìš©ìƒT, í•˜ë¯¸ê²½T', location: 'AI ì‹¬í¬ì§€ì›€' },
                { name: 'í†µí•©ì‚¬íšŒ2', teacher: 'ê¹€í˜•ì„T', location: '1í•™ë…„ 7ë°˜ êµì‹¤' }
            ],
            'ëª©': [
                { name: 'í†µí•©ê³¼í•™2', teacher: 'ì´ìœ¤ìˆ™T', location: '3ì¸µ ë¬¼ë¦¬í•™ ì‹¤í—˜ì‹¤' },
                { name: 'ì¢…êµ', teacher: 'ê¹€ë™í•´ ì‹ ë¶€ë‹˜', location: 'J301' },
                { name: 'ì§„ë¡œ', teacher: 'í•œìƒë¬´T', location: 'ì§„ë¡œì‹¤' },
                { name: 'í•œêµ­ì‚¬2', teacher: 'ì •ê¸°ì—½T', location: '3í•™ë…„ 3ë°˜ êµì‹¤' },
                { name: 'í†µí•©ì‚¬íšŒ2', teacher: 'ê¹€ê¸°ëª¨T', location: '2í•™ë…„ 7ë°˜ êµì‹¤(3ì¸µ)' },
                { name: 'ê³µí†µì˜ì–´2', teacher: 'ì´ì§€ì—°T', location: '1í•™ë…„ 4ë°˜ êµì‹¤' },
                { name: 'í†µí•©ì‚¬íšŒ2', teacher: 'ì„œì •ì„T', location: '2í•™ë…„ 6ë°˜ êµì‹¤(3ì¸µ)' }
            ],
            'ê¸ˆ': [
                { name: 'ì¸ê³µì§€ëŠ¥ê¸°ì´ˆ', teacher: 'ê¹€ìš©ìƒT, í•˜ë¯¸ê²½T', location: 'AI ì‹¬í¬ì§€ì›€' },
                { name: 'ê³µí†µìˆ˜í•™2', teacher: 'ìœ ì§€í˜„T', location: '1í•™ë…„ 5ë°˜ êµì‹¤' },
                { name: 'ê³µí†µì˜ì–´2', teacher: 'ê¹€ì˜ë¯¸T', location: '1í•™ë…„ 6ë°˜ êµì‹¤' },
                { name: 'ê³µí†µêµ­ì–´2', teacher: 'ì „ë¯¼ì§€T', location: 'AI ì¸í…”ë¦¬ë©' },
                { name: 'ì°½ì²´', teacher: '', location: '' },
                { name: 'ì°½ì²´', teacher: '', location: '' },
                { name: 'ì°½ì²´', teacher: '', location: '' }
            ]
        };

        const classTimes = [
            { start: '06:30', end: '07:49', name: 'ì•„ì¹¨ ì‹œê°„', special: true, message: 'ì˜¤ëŠ˜ë„ ë©‹ì§„ í•˜ë£¨ë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”!' },
            { start: '07:50', end: '08:30', name: 'ì•„ì¹¨ í™œë™', special: true, message: 'ì›”,ìˆ˜,ê¸ˆ: ë‹¬ë¦¬ê¸° ë° ì¤„ë„˜ê¸° / í™”,ëª©: ì˜ì–´ ë“£ê¸° í‰ê°€' },
            { start: '08:31', end: '08:40', name: 'ì‰¬ëŠ” ì‹œê°„', special: true, message: '1êµì‹œ ìˆ˜ì—…ì„ ì¤€ë¹„í•˜ì„¸ìš”.', nextPeriod: 0 },
            { start: '08:41', end: '09:30', name: '1êµì‹œ', special: false, period: 0 },
            { start: '09:31', end: '09:40', name: 'ì‰¬ëŠ” ì‹œê°„', special: true, message: '2êµì‹œ ìˆ˜ì—…ì„ ì¤€ë¹„í•˜ì„¸ìš”.', nextPeriod: 1 },
            { start: '09:41', end: '10:30', name: '2êµì‹œ', special: false, period: 1 },
            { start: '10:31', end: '10:40', name: 'ì‰¬ëŠ” ì‹œê°„', special: true, message: '3êµì‹œ ìˆ˜ì—…ì„ ì¤€ë¹„í•˜ì„¸ìš”.', nextPeriod: 2 },
            { start: '10:41', end: '11:30', name: '3êµì‹œ', special: false, period: 2 },
            { start: '11:31', end: '11:40', name: 'ì‰¬ëŠ” ì‹œê°„', special: true, message: '4êµì‹œ ìˆ˜ì—…ì„ ì¤€ë¹„í•˜ì„¸ìš”.', nextPeriod: 3 },
            { start: '11:41', end: '12:30', name: '4êµì‹œ', special: false, period: 3 },
            { start: '12:31', end: '13:30', name: 'ì ì‹¬ì‹œê°„', special: true, message: 'ë§›ìˆëŠ” ì ì‹¬, í–‰ë³µí•œ ì‹œê°„ ë³´ë‚´ì„¸ìš”!', nextPeriod: 4 },
            { start: '13:31', end: '14:20', name: '5êµì‹œ', special: false, period: 4 },
            { start: '14:21', end: '14:30', name: 'ì‰¬ëŠ” ì‹œê°„', special: true, message: '6êµì‹œ ìˆ˜ì—…ì„ ì¤€ë¹„í•˜ì„¸ìš”.', nextPeriod: 5 },
            { start: '14:31', end: '15:20', name: '6êµì‹œ', special: false, period: 5 },
            { start: '15:21', end: '15:40', name: 'ì²­ì†Œ ì‹œê°„', special: true, message: '7êµì‹œ ìˆ˜ì—…ì„ ì¤€ë¹„í•˜ì„¸ìš”.', nextPeriod: 6 },
            { start: '15:41', end: '16:30', name: '7êµì‹œ', special: false, period: 6 },
            { start: '16:31', end: '16:40', name: 'ì‰¬ëŠ” ì‹œê°„', special: true, message: 'ììŠµ(ë°©ê³¼í›„) ì¤€ë¹„ ì‹œê°„ì…ë‹ˆë‹¤.', nextPeriod: 6 },
            { start: '16:41', end: '17:30', name: 'ììŠµ(ë°©ê³¼í›„)', special: true, message: 'ììœ¨ì ìœ¼ë¡œ í•™ìŠµí•˜ëŠ” ì‹œê°„ì…ë‹ˆë‹¤.' },
            { start: '17:31', end: '19:00', name: 'ì €ë… ì‹œê°„', special: true, message: 'ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³  ë§ì•˜ì–´ìš”. ë“ ë“ í•˜ê²Œ ì €ë… ë¨¹ê³  í˜ë‚´ì„¸ìš”!' },
            { start: '18:45', end: '18:59', name: 'ììŠµ ì¤€ë¹„', special: true, message: 'ììŠµì„ ì¤€ë¹„í•˜ì„¸ìš”.' },
            { start: '19:01', end: '20:20', name: 'ììŠµ ì‹œê°„', special: true, message: 'ìê¸°ì£¼ë„ í•™ìŠµ ì‹œê°„ì…ë‹ˆë‹¤.' },
            { start: '20:21', end: '20:40', name: 'ì‰¬ëŠ” ì‹œê°„', special: true, message: 'ì ì‹œ ì‰¬ë©´ì„œ ë‹¤ìŒ ììŠµ ì‹œê°„ì„ ì¤€ë¹„í•˜ì„¸ìš”.' },
            { start: '20:41', end: '21:50', name: 'ììŠµ ì‹œê°„', special: true, message: 'ìê¸°ì£¼ë„ í•™ìŠµ ì‹œê°„ì…ë‹ˆë‹¤.' },
            { start: '21:51', end: '22:00', name: 'ì‰¬ëŠ” ì‹œê°„', special: true, message: 'ì ì‹œ ì‰¬ë©´ì„œ ë‹¤ìŒ ììŠµ ì‹œê°„ì„ ì¤€ë¹„í•˜ì„¸ìš”.' },
            { start: '22:01', end: '23:00', name: 'ììŠµ ì‹œê°„', special: true, message: 'ìê¸°ì£¼ë„ í•™ìŠµ ì‹œê°„ì…ë‹ˆë‹¤.' },
            { start: '23:01', end: '24:00', name: 'ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.', special: true, message: 'ì˜¤ëŠ˜ í•˜ë£¨ ì •ë§ ìˆ˜ê³  ë§ìœ¼ì…¨ìŠµë‹ˆë‹¤. í¸ì•ˆí•œ ë°¤ ë˜ì„¸ìš”!' }
        ];

        function updateTimeAndClass() {
            const now = new Date();
            const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][now.getDay()];
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const currentDate = `${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ${now.getDate()}ì¼ (${dayOfWeek})`;
            const currentTime = `${hours}:${minutes}:${seconds}`;

            document.getElementById('current-date').textContent = currentDate;
            document.getElementById('current-time').textContent = currentTime;

            const teacherNameP = document.getElementById('teacher-name-p');
            const specialMessageEl = document.getElementById('special-message');
            const classNameEl = document.getElementById('class-name');

            let currentClass = '';
            let currentTeacher = 'ì—†ìŒ';
            let currentLocation = 'ì—†ìŒ';
            let currentMessage = '';
            let isTeacherHidden = false;
            let currentPeriodIndex = -1;

            if (dayOfWeek !== 'í† ' && dayOfWeek !== 'ì¼') {
                for (let i = 0; i < classTimes.length; i++) {
                    const classTime = classTimes[i];
                    const [startHours, startMinutes] = classTime.start.split(':').map(Number);
                    const [endHours, endMinutes] = classTime.end.split(':').map(Number);
                    const nowHours = now.getHours();
                    const nowMinutes = now.getMinutes();
                    const nowInMinutes = nowHours * 60 + nowMinutes;
                    const startInMinutes = startHours * 60 + startMinutes;
                    const endInMinutes = endHours * 60 + endMinutes;

                    if (nowInMinutes >= startInMinutes && nowInMinutes < endInMinutes) {
                        if (classTime.special) {
                            currentClass = classTime.name;
                            currentTeacher = 'ì—†ìŒ';
                            currentLocation = 'ì—†ìŒ';
                            currentMessage = classTime.message;
                            isTeacherHidden = true;
                            
                            if (classTime.name.includes('ì‰¬ëŠ” ì‹œê°„') || classTime.name.includes('ì¤€ë¹„')) {
                                const nextPeriodIndex = classTime.nextPeriod;
                                if (timetableData[dayOfWeek] && typeof nextPeriodIndex !== 'undefined') {
                                    const nextClassInfo = timetableData[dayOfWeek][nextPeriodIndex];
                                    if (nextClassInfo) {
                                        currentClass = `${nextPeriodIndex + 1}êµì‹œ ìˆ˜ì—…`;
                                        currentTeacher = nextClassInfo.teacher;
                                        currentLocation = nextClassInfo.location;
                                        currentMessage = `ë‹¤ìŒ ìˆ˜ì—…: ${nextClassInfo.name}`;
                                        isTeacherHidden = false;
                                    }
                                }
                            }
                            if (classTime.name === 'ì ì‹¬ì‹œê°„' && nowHours === 13 && nowMinutes >= 15) {
                                const nextPeriodIndex = classTime.nextPeriod;
                                if (timetableData[dayOfWeek] && typeof nextPeriodIndex !== 'undefined') {
                                    const nextClassInfo = timetableData[dayOfWeek][nextPeriodIndex];
                                    if (nextClassInfo) {
                                        currentClass = `5êµì‹œ ìˆ˜ì—…`;
                                        currentTeacher = nextClassInfo.teacher;
                                        currentLocation = nextClassInfo.location;
                                        currentMessage = `ë‹¤ìŒ ìˆ˜ì—…: ${nextClassInfo.name}`;
                                        isTeacherHidden = false;
                                    }
                                }
                            }
                            if (classTime.name === 'ì²­ì†Œ ì‹œê°„' && nowHours === 15 && nowMinutes >= 20) {
                                const nextPeriodIndex = classTime.nextPeriod;
                                if (timetableData[dayOfWeek] && typeof nextPeriodIndex !== 'undefined') {
                                    const nextClassInfo = timetableData[dayOfWeek][nextPeriodIndex];
                                    if (nextClassInfo) {
                                        currentClass = `7êµì‹œ ìˆ˜ì—…`;
                                        currentTeacher = nextClassInfo.teacher;
                                        currentLocation = nextClassInfo.location;
                                        currentMessage = `ë‹¤ìŒ ìˆ˜ì—…: ${nextClassInfo.name}`;
                                        isTeacherHidden = false;
                                    }
                                }
                            }
                        } else {
                            if (timetableData[dayOfWeek] && typeof classTime.period !== 'undefined') {
                                const classInfo = timetableData[dayOfWeek][classTime.period];
                                if (classInfo) {
                                    currentClass = classInfo.name;
                                    currentTeacher = classInfo.teacher;
                                    currentLocation = classInfo.location;
                                    if (currentClass === 'ì°½ì²´') {
                                        isTeacherHidden = true;
                                        currentTeacher = '';
                                        currentLocation = '';
                                    }
                                } else {
                                    currentClass = classTime.name;
                                    currentTeacher = 'ì •ë³´ ì—†ìŒ';
                                    currentLocation = 'ì •ë³´ ì—†ìŒ';
                                    isTeacherHidden = true;
                                }
                            } else {
                                currentClass = classTime.name;
                                currentTeacher = 'ì—†ìŒ';
                                currentLocation = 'ì—†ìŒ';
                                isTeacherHidden = true;
                            }
                        }
                        if (!classTime.special && typeof classTime.period !== 'undefined') {
                            currentPeriodIndex = classTime.period;
                        }
                        break;
                    }
                }
            } else {
                currentClass = 'ì˜¤ëŠ˜ì€ ì£¼ë§ì…ë‹ˆë‹¤';
                currentTeacher = 'ì—†ìŒ';
                currentLocation = 'ì—†ìŒ';
                currentMessage = 'ì£¼ë§ì€ í‰ì¼ê³¼ ë‹¤ë¥¸ ì‹œê°„í‘œë¡œ ìš´ì˜ë©ë‹ˆë‹¤.';
            }

            classNameEl.textContent = currentClass;
            document.getElementById('teacher-name').textContent = currentTeacher;
            document.getElementById('location').textContent = currentLocation;
            specialMessageEl.textContent = currentMessage;

            if (isTeacherHidden) {
                teacherNameP.style.display = 'none';
            } else {
                teacherNameP.style.display = 'block';
            }

            const cells = document.querySelectorAll('#timetable td');
            cells.forEach(cell => cell.classList.remove('highlight'));
            if (currentPeriodIndex !== -1) {
                const dayIndex = now.getDay();
                const rowToHighlight = document.querySelector(`#timetable tbody tr:nth-child(${currentPeriodIndex + 1})`);
                const cellToHighlight = rowToHighlight.querySelector(`td:nth-child(${dayIndex + 1})`);
                if (cellToHighlight) {
                    cellToHighlight.classList.add('highlight');
                }
            }
        }

        function generateTimetable() {
            const tableBody = document.querySelector('#timetable tbody');
            const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
            
            for (let i = 0; i < 7; i++) {
                const row = document.createElement('tr');
                const periodCell = document.createElement('td');
                periodCell.textContent = `${i + 1}êµì‹œ`;
                row.appendChild(periodCell);

                days.forEach(day => {
                    const classInfo = timetableData[day] && timetableData[day][i];
                    const cell = document.createElement('td');
                    if (classInfo) {
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'class-cell-content';

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'class-name';
                        nameSpan.textContent = classInfo.name;
                        contentDiv.appendChild(nameSpan);

                        const detailsDiv = document.createElement('div');
                        detailsDiv.className = 'class-details';
                        detailsDiv.innerHTML = `<span>${classInfo.teacher}</span><br><span>${classInfo.location}</span>`;
                        contentDiv.appendChild(detailsDiv);

                        cell.appendChild(contentDiv);
                    } else {
                        cell.textContent = 'ì—†ìŒ';
                    }
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            }
        }
        
        function setTimeBasedBackground() {
            const now = new Date();
            const hour = now.getHours();
            const root = document.documentElement;

            if (hour >= 6 && hour < 12) {
                root.style.setProperty('--bg-start-color', '#fffde4');
                root.style.setProperty('--bg-end-color', '#c6ffdd');
                root.style.setProperty('--accent-color', '#a5d6a7');
            } else if (hour >= 12 && hour < 18) {
                root.style.setProperty('--bg-start-color', '#f7d794');
                root.style.setProperty('--bg-end-color', '#f8a5c2');
                root.style.setProperty('--accent-color', '#f58220');
            } else {
                root.style.setProperty('--bg-start-color', '#091e3a');
                root.style.setProperty('--bg-end-color', '#2f5a89');
                root.style.setProperty('--accent-color', '#3498db');
            }
        }

        // --- Weather Feature with Gemini API ---
        async function fetchWeather() {
            const now = new Date();
            const hour = now.getHours();
            const location = 'ì¶©ë‚¨ ë…¼ì‚°ì‹œ';
            let prompt, schema;

            if (hour >= 6 && hour < 23) {
                prompt = `ì¶©ë‚¨ ë…¼ì‚°ì‹œì˜ í˜„ì¬ ë‚ ì”¨ì™€ ê¸°ì˜¨ì„ ì•Œë ¤ì£¼ì„¸ìš”.`;
                schema = {
                    type: "OBJECT",
                    properties: {
                        "temperature": { "type": "STRING" },
                        "weather_description": { "type": "STRING" },
                        "weather_icon": { "type": "STRING" }
                    },
                    required: ["temperature", "weather_description", "weather_icon"]
                };
            } else {
                prompt = `ì˜¤ëŠ˜ ê¸°ì˜¨ì´ 25ë„ì´ê³ , ì¶©ë‚¨ ë…¼ì‚°ì‹œì˜ ë‚´ì¼ ê¸°ì˜¨ì´ 20ë„ë¼ë©´ 'ë‚´ì¼ì€ ì˜¤ëŠ˜ë³´ë‹¤ 5ë„ ë‚®ì•„ì¡ŒìŠµë‹ˆë‹¤.'ë¼ê³  ë§í•´ì¤˜. ë˜í•œ, ë‚´ì¼ ì¶©ë‚¨ ë…¼ì‚°ì‹œì˜ ë‚ ì”¨ë¥¼ í™•ì¸í•˜ê³ , ë¹„ê°€ ì˜¨ë‹¤ë©´ 'ë¹„ê°€ ì˜¤ë‹ˆ ìš°ì‚°ì„ ì±™ê²¨ì£¼ì„¸ìš”!'ë¼ê³ , ì•ˆê°œê°€ ê»´ìˆë‹¤ë©´ 'ì‹œì•¼ í™•ë³´ì— ì‹ ê²½ì„ ì¨ì£¼ì„¸ìš”!'ë¼ê³  ì¹œì ˆí•˜ê²Œ ì¡°ì–¸í•˜ëŠ” ë¬¸êµ¬ë¥¼ í¬í•¨í•´ ì£¼ì„¸ìš”.`;
                schema = {
                    type: "OBJECT",
                    properties: {
                        "next_day_message": { "type": "STRING" },
                        "temp_change_message": { "type": "STRING" },
                        "weather_icon": { "type": "STRING" }
                    },
                    required: ["next_day_message", "temp_change_message", "weather_icon"]
                };
            }
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };

            const apiKey = "AIzaSyBK2pndEUqDo4HZmnBSpzzgnaqQkGqsB4A";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result?.candidates?.[0];
                const jsonText = candidate?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const weatherData = JSON.parse(jsonText);
                    const weatherIconEl = document.getElementById('weather-icon');
                    const temperatureEl = document.getElementById('temperature');
                    const specialMessageEl = document.getElementById('special-message');

                    // Set weather icon based on description
                    let icon = 'â˜€ï¸'; // Default to sun
                    if (weatherData.weather_icon) {
                        const description = weatherData.weather_icon.toLowerCase();
                        if (description.includes('ë¹„') || description.includes('rain')) icon = 'ğŸŒ§ï¸';
                        else if (description.includes('êµ¬ë¦„') || description.includes('cloud')) icon = 'â˜ï¸';
                        else if (description.includes('ëˆˆ') || description.includes('snow')) icon = 'â„ï¸';
                        else if (description.includes('ì•ˆê°œ') || description.includes('fog')) icon = 'ğŸŒ«ï¸';
                        else if (description.includes('ë°”ëŒ') || description.includes('wind')) icon = 'ğŸŒ¬ï¸';
                    }
                    weatherIconEl.textContent = icon;

                    if (hour >= 6 && hour < 23) {
                        temperatureEl.textContent = weatherData.temperature || 'ì •ë³´ ì—†ìŒ';
                        specialMessageEl.innerHTML = '';
                    } else {
                        temperatureEl.textContent = '';
                        specialMessageEl.innerHTML = `
                            ${weatherData.next_day_message}<br>
                            ${weatherData.temp_change_message}
                        `;
                    }
                } else {
                    console.error('API response is empty or malformed.');
                }
            } catch (error) {
                console.error("API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                document.getElementById('weather-icon').textContent = 'âš ï¸';
                document.getElementById('temperature').textContent = 'ë‚ ì”¨ ì •ë³´ ì—†ìŒ';
            }
        }

        // --- Announcement feature with Firestore ---
        const ADMIN_CODE = 'Admin0301';
        let isAdminMode = false;
        let announcementsListener = null;

        function loadAnnouncements() {
            if (!window.firebase.isAuthReady()) {
                console.log("Firebase not ready, waiting for auth state.");
                return;
            }
        
            const { db, appId, onSnapshot, collection } = window.firebase;
            const announcementsRef = collection(db, `artifacts/${appId}/public/data/announcements`);
            
            // Detach previous listener to prevent duplicates
            if (announcementsListener) {
                announcementsListener();
            }

            announcementsListener = onSnapshot(announcementsRef, (snapshot) => {
                const announcements = [];
                snapshot.forEach(doc => {
                    announcements.push({ id: doc.id, text: doc.data().text });
                });
                renderAnnouncements(announcements);
                if (isAdminMode) {
                    renderAdminPanel(announcements);
                }
            }, (error) => {
                console.error("Failed to load announcements:", error);
                showInfoBox('ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        function renderAnnouncements(announcements) {
            const announcementEl = document.getElementById('announcement-content');
            announcementEl.innerHTML = '';
            
            if (announcements.length === 0) {
                announcementEl.textContent = 'ì•„ì§ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }

            announcements.forEach(announcement => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'announcement-item';
                
                const textSpan = document.createElement('span');
                textSpan.className = 'announcement-text';
                textSpan.innerHTML = announcement.text; // Use innerHTML to render <br>
                itemDiv.appendChild(textSpan);
                
                announcementEl.appendChild(itemDiv);
            });
        }
        
        function showCodeModal() {
            document.getElementById('code-modal').style.display = 'flex';
        }

        function checkAdminCode() {
            const codeInput = document.getElementById('admin-code-input');
            const code = codeInput.value;
            const modalMessage = document.getElementById('modal-message');

            if (code === ADMIN_CODE) {
                document.getElementById('code-modal').style.display = 'none';
                enterAdminMode();
                showInfoBox('ê´€ë¦¬ì ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                modalMessage.textContent = 'ê´€ë¦¬ì ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                setTimeout(() => modalMessage.textContent = '', 2000);
            }
            codeInput.value = '';
        }

        function enterAdminMode() {
            isAdminMode = true;
            document.getElementById('admin-panel').style.display = 'block';
            loadAnnouncements(); // Reload to render admin view
        }

        function exitAdminMode() {
            isAdminMode = false;
            document.getElementById('admin-panel').style.display = 'none';
        }
        
        function renderAdminPanel(announcements) {
            const adminListEl = document.getElementById('admin-announcement-list');
            adminListEl.innerHTML = '';
            
            if (announcements.length === 0) {
                adminListEl.textContent = 'ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.';
            }

            announcements.forEach(announcement => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'announcement-item';
                
                const textSpan = document.createElement('span');
                textSpan.className = 'announcement-text';
                textSpan.innerHTML = announcement.text;
                itemDiv.appendChild(textSpan);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'ì‚­ì œ';
                deleteBtn.className = 'delete-btn';
                deleteBtn.dataset.id = announcement.id; // Use dataset for ID
                itemDiv.appendChild(deleteBtn);
                
                adminListEl.appendChild(itemDiv);
            });
        }
        
        async function addAnnouncement() {
            const { db, appId, addDoc, collection } = window.firebase;
            const input = document.getElementById('new-announcement-input');
            const newAnnouncementText = input.value.trim();
            if (newAnnouncementText) {
                try {
                    const announcementsRef = collection(db, `artifacts/${appId}/public/data/announcements`);
                    // Replace newlines with <br> for HTML rendering
                    const formattedText = newAnnouncementText.replace(/\n/g, '<br>');
                    await addDoc(announcementsRef, {
                        text: formattedText,
                        createdAt: new Date()
                    });
                    input.value = '';
                    showInfoBox('âœ… ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (e) {
                    console.error("Error adding announcement:", e);
                    showInfoBox('âŒ ê³µì§€ì‚¬í•­ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ì½˜ì†”ì—ì„œ ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”.');
                }
            }
        }
        
        async function deleteAnnouncement(announcementId) {
            const { db, appId, doc, deleteDoc } = window.firebase;
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/announcements`, announcementId);
                await deleteDoc(docRef);
                showInfoBox('âœ… ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) {
                console.error("Error deleting announcement:", e);
                showInfoBox('âŒ ê³µì§€ì‚¬í•­ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ì½˜ì†”ì—ì„œ ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”.');
            }
        }

        function showInfoBox(message) {
            const infoBox = document.createElement('div');
            infoBox.textContent = message;
            infoBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #333;
                color: white;
                padding: 15px 30px;
                border-radius: 8px;
                z-index: 3000;
                opacity: 0;
                transition: opacity 0.5s ease;
            `;
            document.body.appendChild(infoBox);
            setTimeout(() => {
                infoBox.style.opacity = '1';
            }, 10);
            setTimeout(() => {
                infoBox.style.opacity = '0';
                setTimeout(() => infoBox.remove(), 500);
            }, 2000);
        }

        function attachEventListeners() {
            document.getElementById('admin-mode-btn').addEventListener('click', showCodeModal);
            document.getElementById('check-code-btn').addEventListener('click', checkAdminCode);
            document.getElementById('exit-admin-btn').addEventListener('click', exitAdminMode);
            document.getElementById('add-announcement-btn').addEventListener('click', addAnnouncement);
            document.getElementById('admin-announcement-list').addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-btn')) {
                    const announcementId = event.target.dataset.id;
                    deleteAnnouncement(announcementId);
                }
            });
        }

        // í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ì‹¤í–‰
        window.onload = function () {
            generateTimetable();
            setTimeBasedBackground();
            updateTimeAndClass();
            setInterval(updateTimeAndClass, 1000);
            fetchWeather(); // Fetch weather on page load
            attachEventListeners();
        };
    </script>
</body>
</html>
